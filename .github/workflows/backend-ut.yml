# ğŸš€ ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•ã§å®Ÿè¡Œã—ã¦å“è³ªã‚’å®ˆã‚‹ãŸã‚ã®è¨­å®šã§ã™
name: Backend UT

on:
  # ğŸ” main ãƒ–ãƒ©ãƒ³ãƒå‘ã‘ã® push ã¨ Pull Request ã«åå¿œã•ã›ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé–‹ç™ºãƒ•ãƒ­ãƒ¼ã‚’ã‚«ãƒãƒ¼ã™ã‚‹
  push:
    branches: ["main"]
    paths:
      - "backend/**"
  pull_request:
    branches: ["main"]
    paths:
      - "backend/**"

jobs:
  backend-ut:
    # ğŸ§ª ã‚¸ãƒ§ãƒ–åã¯ã‚ã‹ã‚Šã‚„ã™ãã€ŒRun backend unit tests via Makefileã€ã¨ã™ã‚‹
    name: Run backend unit tests via Makefile
    runs-on: ubuntu-latest

    # ğŸ—„ï¸ jOOQ ã®ã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒ PostgreSQL ã¸ã®æ¥ç¶šã‚’å¿…è¦ã¨ã™ã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦èµ·å‹•ã™ã‚‹
    services:
      postgres:
        image: postgres:15
        # ğŸ” Flyway / jOOQ ã§åˆ©ç”¨ã™ã‚‹è³‡æ ¼æƒ…å ±ã‚’åˆã‚ã›ã¦è¨­å®šã—ã€Makefile ã®ãƒ†ã‚¹ãƒˆã§ã‚‚å†åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        env:
          POSTGRES_USER: demo
          POSTGRES_PASSWORD: demo123
          POSTGRES_DB: demodb
        ports:
          - 5432:5432
        # â³ DB ãŒèµ·å‹•ã—ãã‚‹å‰ã«ãƒ†ã‚¹ãƒˆãŒèµ°ã£ã¦å¤±æ•—ã—ãªã„ã‚ˆã†ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å³ã—ã‚ã«è¨­å®šã™ã‚‹
        options: >-
          --health-cmd "pg_isready -U demo"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # ğŸ˜ PostgreSQL ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«éƒ½åº¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹å¾…ã¡æ™‚é–“ã‚’æ¸›ã‚‰ã™ãŸã‚ã€äº‹å‰ã« docker pull ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹
      - name: Pre-pull PostgreSQL service image
        run: |
          docker pull postgres:15

      # âœ… ãƒªãƒã‚¸ãƒˆãƒªã®å®Œå…¨ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¦å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      - name: Checkout repository
        uses: actions/checkout@v4

      # â˜•ï¸ Java 21 ã®å®Ÿè¡Œç’°å¢ƒã‚’æ§‹ç¯‰ã—ã€Gradle ãƒ“ãƒ«ãƒ‰ã‚„ãƒ†ã‚¹ãƒˆãŒæ­£ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å‹•ãã‚ˆã†ã«æº–å‚™ã™ã‚‹
      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle  # ğŸ“¦ Gradle ã®ä¾å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œæ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹

      # ğŸš„ Gradle Build Action ã‚’è¿½åŠ ã—ã¦ä¾å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã ã‘ã§ãªãã€Wrapper ã‚„è¨­å®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚åŠ¹ã‹ã›ã¦ã•ã‚‰ã«ãƒ“ãƒ«ãƒ‰ã‚’é«˜é€ŸåŒ–ã™ã‚‹
      - name: Prepare Gradle build cache
        uses: gradle/actions/setup-gradle@v3
        with:
          # ğŸ” main ä»¥å¤–ã§ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã«ã—ã¦ PR åŒå£«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç«¶åˆã‚’é¿ã‘ã¤ã¤ã€main ã§ã¯æ›¸ãè¾¼ã¿ã‚‚è¨±å¯ã™ã‚‹
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      # ğŸ§± jOOQ ã®ã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒå‚ç…§ã™ã‚‹ã‚¹ã‚­ãƒ¼ãƒã‚’ Flyway ã§æœ€æ–°åŒ–ã—ã¦ãŠãã¨ã€ç”Ÿæˆã¨ãƒ†ã‚¹ãƒˆã®ã©ã¡ã‚‰ã‚‚å®‰å®šã™ã‚‹
      - name: Run Flyway migrations and regenerate jOOQ sources via Makefile
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/demodb
          SPRING_DATASOURCE_USERNAME: demo
          SPRING_DATASOURCE_PASSWORD: demo123
        run: |
          make backend-db-refresh

      # ğŸ§° make ã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨ã§ãã‚‹ã“ã¨ã‚’æ˜ç¤ºçš„ã«ä¿è¨¼ã—ã¤ã¤ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨ã® make ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å®Ÿè¡Œã™ã‚‹
      - name: Run backend unit tests
        env:
          # ğŸŒ Gradle ãŒ localhost ã§èµ·å‹•ã—ãŸ PostgreSQL ã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãƒ›ã‚¹ãƒˆåã‚’æ˜ç¤ºã™ã‚‹
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/demodb
          SPRING_DATASOURCE_USERNAME: demo
          SPRING_DATASOURCE_PASSWORD: demo123
        run: |
          # ğŸ§ª Gradle ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’é€šã˜ã¦ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€Makefile ã® backend-ut ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å©ã
          make backend-ut
