# ğŸš€ ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•ã§å®Ÿè¡Œã—ã¦å“è³ªã‚’å®ˆã‚‹ãŸã‚ã®è¨­å®šã§ã™
name: Backend UT

on:
  # ğŸ” main ãƒ–ãƒ©ãƒ³ãƒå‘ã‘ã® push ã¨ Pull Request ã«åå¿œã•ã›ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé–‹ç™ºãƒ•ãƒ­ãƒ¼ã‚’ã‚«ãƒãƒ¼ã™ã‚‹
  push:
    branches: ["main"]
    paths:
      - "backend/**"
  pull_request:
    branches: ["main"]
    paths:
      - "backend/**"

jobs:
  backend-ut:
    # ğŸ§ª ã‚¸ãƒ§ãƒ–åã¯ã‚ã‹ã‚Šã‚„ã™ãã€ŒRun backend unit tests via Makefileã€ã¨ã™ã‚‹
    name: Run backend unit tests via Makefile
    runs-on: ubuntu-latest

    # ğŸ—„ï¸ jOOQ ã®ã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒ PostgreSQL ã¸ã®æ¥ç¶šã‚’å¿…è¦ã¨ã™ã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦èµ·å‹•ã™ã‚‹
    services:
      postgres:
        image: postgres:15
        # ğŸ” Flyway / jOOQ ã§åˆ©ç”¨ã™ã‚‹è³‡æ ¼æƒ…å ±ã‚’åˆã‚ã›ã¦è¨­å®šã—ã€Makefile ã®ãƒ†ã‚¹ãƒˆã§ã‚‚å†åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        env:
          POSTGRES_USER: demo
          POSTGRES_PASSWORD: demo123
          POSTGRES_DB: demodb
        ports:
          - 5432:5432
        # â³ DB ãŒèµ·å‹•ã—ãã‚‹å‰ã«ãƒ†ã‚¹ãƒˆãŒèµ°ã£ã¦å¤±æ•—ã—ãªã„ã‚ˆã†ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å³ã—ã‚ã«è¨­å®šã™ã‚‹
        options: >-
          --health-cmd "pg_isready -U demo"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # ğŸ˜ PostgreSQL ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«éƒ½åº¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹å¾…ã¡æ™‚é–“ã‚’æ¸›ã‚‰ã™ãŸã‚ã€äº‹å‰ã« docker pull ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹
      - name: Pre-pull PostgreSQL service image
        run: |
          docker pull postgres:15

      # âœ… ãƒªãƒã‚¸ãƒˆãƒªã®å®Œå…¨ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¦å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      - name: Checkout repository
        uses: actions/checkout@v4

      # â˜•ï¸ Java 21 ã®å®Ÿè¡Œç’°å¢ƒã‚’æ§‹ç¯‰ã—ã€Gradle ãƒ“ãƒ«ãƒ‰ã‚„ãƒ†ã‚¹ãƒˆãŒæ­£ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å‹•ãã‚ˆã†ã«æº–å‚™ã™ã‚‹
      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle  # ğŸ“¦ Gradle ã®ä¾å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œæ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹

      # ğŸš„ Gradle Build Action ã‚’è¿½åŠ ã—ã¦ä¾å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã ã‘ã§ãªãã€Wrapper ã‚„è¨­å®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚åŠ¹ã‹ã›ã¦ã•ã‚‰ã«ãƒ“ãƒ«ãƒ‰ã‚’é«˜é€ŸåŒ–ã™ã‚‹
      - name: Prepare Gradle build cache
        uses: gradle/actions/setup-gradle@v3
        with:
          # ğŸ” main ä»¥å¤–ã§ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã«ã—ã¦ PR åŒå£«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç«¶åˆã‚’é¿ã‘ã¤ã¤ã€main ã§ã¯æ›¸ãè¾¼ã¿ã‚‚è¨±å¯ã™ã‚‹
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      # ğŸ§± jOOQ ã®ã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒå‚ç…§ã™ã‚‹ã‚¹ã‚­ãƒ¼ãƒã‚’ Flyway ã§æœ€æ–°åŒ–ã—ã¦ãŠãã¨ã€ç”Ÿæˆã¨ãƒ†ã‚¹ãƒˆã®ã©ã¡ã‚‰ã‚‚å®‰å®šã™ã‚‹
      - name: Run Flyway migrations and regenerate jOOQ sources via Makefile
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/demodb
          SPRING_DATASOURCE_USERNAME: demo
          SPRING_DATASOURCE_PASSWORD: demo123
        run: |
          make backend-db-refresh

      # ğŸ§° make ã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨ã§ãã‚‹ã“ã¨ã‚’æ˜ç¤ºçš„ã«ä¿è¨¼ã—ã¤ã¤ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨ã® make ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å®Ÿè¡Œã™ã‚‹
      - name: Run backend unit tests with coverage
        env:
          # ğŸŒ Gradle ãŒ localhost ã§èµ·å‹•ã—ãŸ PostgreSQL ã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãƒ›ã‚¹ãƒˆåã‚’æ˜ç¤ºã™ã‚‹
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/demodb
          SPRING_DATASOURCE_USERNAME: demo
          SPRING_DATASOURCE_PASSWORD: demo123
        run: |
          # ğŸ§ª jacocoTestReport ã‚¿ã‚¹ã‚¯ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ã‚«ãƒãƒ¬ãƒƒã‚¸åé›†ã®ä¸¡æ–¹ã‚’è¡Œã†ã®ã§ backend-coverage ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’åˆ©ç”¨ã™ã‚‹
          make backend-coverage

      # ğŸ“Š Jacoco ã® XML ãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰è¡Œã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ã‚’æŠ½å‡ºã—ã€å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã‚„ã‚µãƒãƒªãƒ¼ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      - name: Extract coverage summary
        id: coverage
        run: |
          coverage_output=$(python3 <<'PY'
from decimal import Decimal, ROUND_HALF_UP
from pathlib import Path
import xml.etree.ElementTree as ET

report = Path("backend/build/reports/jacoco/test/jacocoTestReport.xml")
if not report.is_file():
    raise SystemExit(f"Jacoco report not found at {report}")

root = ET.parse(report).getroot()
covered = Decimal('0')
missed = Decimal('0')
for counter in root.iter('counter'):
    if counter.get('type') == 'LINE':
        covered += Decimal(counter.get('covered', '0'))
        missed += Decimal(counter.get('missed', '0'))

total = covered + missed
if total == 0:
    percent = Decimal('0.00')
else:
    percent = (covered / total * 100).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)

print(f"covered={covered}")
print(f"missed={missed}")
print(f"total={total}")
print(f"line_rate={percent}")
PY
)

          while IFS='=' read -r key value; do
            echo "${key}=${value}" >> "$GITHUB_OUTPUT"
          done <<< "${coverage_output}"

      # ğŸ§¾ Step Summary ã« PR ç•ªå·ã‚„ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã¨åˆã‚ã›ã¦ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¨˜éŒ²ã™ã‚‹
      - name: Publish coverage summary
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          LINE_RATE: ${{ steps.coverage.outputs.line_rate }}
        run: |
          if [[ -n "${PR_NUMBER}" ]]; then
            REF_LABEL="PR #${PR_NUMBER}"
          else
            REF_LABEL="${GITHUB_REF}"
          fi

          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
### Backend Jacoco Coverage

EOF
          {
            echo "- Reference: ${REF_LABEL}"
            echo "- Line coverage: ${LINE_RATE}%"
          } >> "$GITHUB_STEP_SUMMARY"

      # ğŸ’¾ HTML ãƒ¬ãƒãƒ¼ãƒˆä¸€å¼ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ã—ã€å¾Œæ®µã® GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ã‚„æ‰‹å‹•ç¢ºèªã«å‚™ãˆã‚‹
      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jacoco-report
          path: backend/build/reports/jacoco/test
          if-no-files-found: error
          retention-days: 7

  deploy-coverage:
    name: Publish coverage to GitHub Pages
    needs: backend-ut
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Download coverage report artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jacoco-report
          path: public

      - name: Add branch metadata
        run: |
          cat <<EOF > public/metadata.json
          {
            "ref": "${GITHUB_REF}",
            "sha": "${GITHUB_SHA}"
          }
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
